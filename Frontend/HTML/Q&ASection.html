<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  <link rel="stylesheet" href="/css/Q&AStyles.css" />
  <title>Questions & Answers</title>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-container">
      <a href="/" class="logo">UniCareerHub</a>
      <div class="nav-title">Questions & Answers</div>
      <div class="user-actions">
        <a href="/profile" class="user-icon">
          <i class="fas fa-user-circle"></i>
        </a>
        <a href="/logout">
          <button class="logout-btn">Logout</button>
        </a>
      </div>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="hero">
    <div class="hero-images">
      <img src="/pics/QA1.png" alt="QA Image 1">
    </div>
    <div class="hero-content">
      <h2>Empowering Students & Graduates</h2>
      <p>Got a question? Don't hesitate to ask!
        Engage with students and professionals to get the answers you need.</p>
      <div class="hero-controls">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search for questions..." 
        />
      </div>
    </div>
    <div class="hero-images">
      <img src="/pics/QA2.png" alt="QA Image 2">
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main>
    <h2 class="section-title">Latest Questions</h2>
    <button id="open-modal" class="floating-btn">
      <i class="fas fa-plus"></i> Add a Question
    </button>
    <!-- Questions Section -->
    <section id="qa-section">
      <div class="container">
        <div class="questions-list" id="questions-list"></div>
      </div>
    </section>

    <!-- Add Question Modal -->
    <div id="review-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3><i class="fas fa-pen-nib"></i> Ask a Question</h3>
        <form id="question-form" class="ask-question">
          <div class="form-group">
            <label for="question-title">Title of Your Question</label>
            <input
              type="text"
              id="question-title"
              name="title"
              placeholder="Enter a descriptive question title"
              required
            />
          </div>
          <div class="form-group">
            <label for="question-body">Details</label>
            <textarea
              id="question-body"
              name="body"
              placeholder="Provide details about your question"
              required
            ></textarea>
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-paper-plane"></i> Post Question
          </button>
        </form>
      </div>
    </div>

    <!-- Report Modal (used for both questions & replies) -->
    <div id="report-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeReportModal()">&times;</span>
        <h3><i class="fas fa-flag"></i> Report</h3>
        <form id="report-form">
          <label for="report-reason">Why are you reporting this?</label>
          <textarea id="report-reason" placeholder="Enter your reason..." required></textarea>
          <button type="submit" class="submit-btn">Submit Report</button>
        </form>
      </div>
    </div>
    <!-- Nested Comment Modal -->
<div id="comment-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="close-comment-modal">&times;</span>
    <h3><i class="fas fa-comments"></i> Reply Comments</h3>
    <div id="comment-thread" class="comments-thread"></div>
    <textarea id="comment-input" placeholder="Write a comment..."></textarea>
    <button id="submit-comment-btn" class="submit-btn">Post Comment</button>
  </div>
</div>



  </main>

  <script src="/js/api.js"></script>
  <script>
    // Helper function to update the visibility of the toggle replies button.
    function updateToggleReplies(repliesList, toggleBtn) {
      if (repliesList.childElementCount === 0) {
        toggleBtn.style.display = "none";
      } else {
        toggleBtn.style.display = "inline-block";
      }
    }

    // Global variable to store all questions
    let allQuestions = [];

    // Modal functionality for "Add a Question"
    document.getElementById("open-modal").addEventListener("click", function () {
      document.getElementById("review-modal").style.display = "block";
    });
    document.querySelectorAll(".close-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const modal = this.closest(".modal");
    if (modal) modal.style.display = "none";
  });
});

    window.addEventListener("click", function (event) {
      if (event.target === document.getElementById("review-modal")) {
        document.getElementById("review-modal").style.display = "none";
      }
      if (event.target === document.getElementById("report-modal")) {
        closeReportModal();
      }
   
      if (event.target === document.getElementById("comment-modal")) {
  commentModal.style.display = "none";
  commentThread.innerHTML = "";
  commentInput.value = "";
  activeReply = null;
}

   
    });

    // Function to load the latest questions from the server
    async function loadLatestQuestions() {
      try {
        const response = await fetch("/Q&A/latest");
        if (!response.ok) {
          console.error("Failed to load questions");
          return;
        }
        const latestQuestions = await response.json();
        allQuestions = latestQuestions; // Update the global variable
        renderQuestions(latestQuestions); // Render all questions
      } catch (error) {
        console.error("Error loading latest questions:", error);
      }
    }
    function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    }
    window.currentUser = getCookie('currentUser');

    // Function to render questions dynamically
    function renderQuestions(questions) {
      
  const questionsList = document.getElementById("questions-list");
  questionsList.innerHTML = ""; // Clear previous questions

  // Assume window.currentUser is set to the logged-in user's username
  const currentUser = window.currentUser; 
  console.log("Current User:", currentUser);

  questions.forEach((q) => {
    
    const questionElem = document.createElement("div");
    questionElem.classList.add("question");

    // Build the menu options conditionally
    let deleteButtonHTML = "";
    if (q.username === currentUser) {
      deleteButtonHTML = `<button class="delete-btn">Delete</button>`;
    }
    // Always include the report button
    deleteButtonHTML += `<button class="report-btn">Report</button>`;

    questionElem.innerHTML = `
      <div class="question-header">
        <h4>${q.title}</h4>
        <p class="question-meta">
          <i class="fas fa-user"></i> Posted by: ${q.username} | Time: ${new Date(q.time).toLocaleString()}
        </p>
        <div class="three-dot-menu">
          <span class="dots">&#8226;&#8226;&#8226;</span>
          <div class="menu-options">
            ${deleteButtonHTML}
          </div>
        </div>
      </div>
      <div class="question-body">
        <p>${q.question}</p>
      </div>
      <!-- additional HTML for replies etc. -->
    `;

    // Add event listeners for the menu buttons as neededâ€¦
    const threeDotMenu = questionElem.querySelector(".three-dot-menu");
    const menuOptions = threeDotMenu.querySelector(".menu-options");

    threeDotMenu.addEventListener("click", function (e) {
      e.stopPropagation();
      menuOptions.classList.toggle("show");
    });

    if (q.username === currentUser) {
      // Assuming each question object (q) contains a property "ID" and you attach it to a data attribute:
questionElem.setAttribute("data-id", q.ID);

// Then, in your delete button event listener:
const deleteBtn = questionElem.querySelector(".delete-btn");
if (deleteBtn) {
  deleteBtn.addEventListener("click", function (e) {
    const questionId = questionElem.getAttribute("data-id");
    fetch(`/Q&A/${questionId}`, {
      method: 'DELETE',
      credentials: 'include'
    })
      .then(response => response.json())
      .then(result => {
        if (result.message) {
          // Successfully removed on the server, now remove from the DOM.
          questionElem.remove();
        } else {
          alert("Error removing question.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error removing question.");
      });
  });
}

    }

    // Always attach the report button event
    const reportBtn = questionElem.querySelector(".report-btn");
    reportBtn.addEventListener("click", function () {
      document.getElementById("report-modal").style.display = "flex";
    });

    questionsList.appendChild(questionElem);
  });
}


    // Live search functionality
    const searchInput = document.querySelector(".search-input");
    searchInput.addEventListener("input", function () {
      const searchQuery = this.value.toLowerCase();
      renderQuestions(searchQuery === "" ? allQuestions : allQuestions.filter(q => q.title.toLowerCase().includes(searchQuery)));
    });
    searchInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        const searchQuery = this.value.toLowerCase();
        renderQuestions(searchQuery === "" ? allQuestions : allQuestions.filter(q => q.title.toLowerCase().includes(searchQuery)));
      }
    });

    // Submit new question
    document.getElementById("question-form").addEventListener("submit", async function (event) {
      event.preventDefault();
      const title = document.getElementById("question-title").value;
      const body = document.getElementById("question-body").value;
      if (title && body) {
        try {
          const response = await fetch("/Q&A", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: title, question: body }),
            credentials: "include"
          });
          if (!response.ok) {
            alert("Error posting question.");
            return;
          }
          document.getElementById("question-title").value = "";
          document.getElementById("question-body").value = "";
          document.getElementById("review-modal").style.display = "none";
          loadLatestQuestions();
        } catch (error) {
          console.error("Error posting question:", error);
          alert("Error posting question.");
        }
      }
    });

    function closeReportModal() {
      document.getElementById("report-modal").style.display = "none";
      document.getElementById("report-reason").value = "";
    }
    document.getElementById("report-form").addEventListener("submit", function (event) {
      event.preventDefault();
      const reason = document.getElementById("report-reason").value;
      alert("Report submitted: " + reason);
      closeReportModal();
    });
    document.addEventListener("click", function (e) {
      document.querySelectorAll(".menu-options").forEach(menu => menu.classList.remove("show"));
    });
    document.addEventListener("DOMContentLoaded", loadLatestQuestions);


    let activeReply = null; // store the current reply being commented on

// Modal logic
const commentModal = document.getElementById("comment-modal");
const closeCommentModalBtn = document.getElementById("close-comment-modal");
const commentThread = document.getElementById("comment-thread");
const commentInput = document.getElementById("comment-input");
const submitCommentBtn = document.getElementById("submit-comment-btn");

closeCommentModalBtn.addEventListener("click", () => {
  commentModal.style.display = "none";
  commentThread.innerHTML = "";
  commentInput.value = "";
  activeReply = null;
});

submitCommentBtn.addEventListener("click", () => {
  const commentText = commentInput.value.trim();
  if (commentText && activeReply) {
    activeReply.comments = activeReply.comments || [];
    activeReply.comments.push({
      user: "You",
      text: commentText
    });

    // Render
    const commentDiv = document.createElement("div");
    commentDiv.classList.add("comment");
    commentDiv.innerHTML = `<strong>You:</strong> ${commentText}`;
    commentThread.appendChild(commentDiv);

    commentInput.value = "";
  }
});


  </script>
</body>
</html>