<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  <link rel="stylesheet" href="/css/Q&AStyles.css" />
  <title>Questions & Answers</title>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-container">
      <a href="/" class="logo">UniCareerHub</a>
      <div class="nav-title">Questions & Answers</div>
      <div class="user-actions">
        <a href="/profile" class="user-icon">
          <i class="fas fa-user-circle"></i>
        </a>
        <a href="/logout">
          <button class="logout-btn">Logout</button>
        </a>
      </div>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="hero">
    <div class="hero-images">
      <img src="/pics/QA1.png" alt="QA Image 1">
    </div>
    <div class="hero-content">
      <h2>Empowering Students & Graduates</h2>
      <p>Got a question? Don't hesitate to ask!
        Engage with students and professionals to get the answers you need.</p>
      <div class="hero-controls">
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search for questions..." 
        />
      </div>
    </div>
    <div class="hero-images">
      <img src="/pics/QA2.png" alt="QA Image 2">
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main>
    <h2 class="section-title">Latest Questions</h2>
    <button id="open-modal" class="floating-btn">
      <i class="fas fa-plus"></i> Add a Question
    </button>
    <!-- Questions Section -->
    <section id="qa-section">
      <div class="container">
        <div class="questions-list" id="questions-list"></div>
      </div>
    </section>

    <!-- Add Question Modal -->
    <div id="review-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3><i class="fas fa-pen-nib"></i> Ask a Question</h3>
        <form id="question-form" class="ask-question">
          <div class="form-group">
            <label for="question-title">Title of Your Question</label>
            <input
              type="text"
              id="question-title"
              name="title"
              placeholder="Enter a descriptive question title"
              required
            />
          </div>
          <div class="form-group">
            <label for="question-body">Details</label>
            <textarea
              id="question-body"
              name="body"
              placeholder="Provide details about your question"
              required
            ></textarea>
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-paper-plane"></i> Post Question
          </button>
        </form>
      </div>
    </div>

    <!-- Report Modal (used for both questions & replies) -->
    <div id="report-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeReportModal()">&times;</span>
        <h3><i class="fas fa-flag"></i> Report</h3>
        <form id="report-form">
          <label for="report-reason">Why are you reporting this?</label>
          <textarea id="report-reason" placeholder="Enter your reason..." required></textarea>
          <button type="submit" class="submit-btn">Submit Report</button>
        </form>
      </div>
    </div>
    <!-- Nested Comment Modal -->
<div id="comment-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="close-comment-modal">&times;</span>
    <h3><i class="fas fa-comments"></i> Reply Comments</h3>
    <div id="comment-thread" class="comments-thread"></div>
    <textarea id="comment-input" placeholder="Write a comment..."></textarea>
    <button id="submit-comment-btn" class="submit-btn">Post Comment</button>
  </div>
</div>



  </main>

  <script src="/js/api.js"></script>
  <script>
    // Helper function to update the visibility of the toggle replies button.
    function updateToggleReplies(repliesList, toggleBtn) {
      if (repliesList.childElementCount === 0) {
        toggleBtn.style.display = "none";
      } else {
        toggleBtn.style.display = "inline-block";
      }
    }

    // Global variable to store all questions
    let allQuestions = [];

    // Modal functionality for "Add a Question"
    document.getElementById("open-modal").addEventListener("click", function () {
      document.getElementById("review-modal").style.display = "block";
    });
    document.querySelectorAll(".close-btn").forEach(btn => {
  btn.addEventListener("click", function () {
    const modal = this.closest(".modal");
    if (modal) modal.style.display = "none";
  });
});

    window.addEventListener("click", function (event) {
      if (event.target === document.getElementById("review-modal")) {
        document.getElementById("review-modal").style.display = "none";
      }
      if (event.target === document.getElementById("report-modal")) {
        closeReportModal();
      }
   
      if (event.target === document.getElementById("comment-modal")) {
  commentModal.style.display = "none";
  commentThread.innerHTML = "";
  commentInput.value = "";
  activeReply = null;
}

   
    });

    // Function to load the latest questions from the server
    async function loadLatestQuestions() {
      try {
        const response = await fetch("/Q&A/latest");
        if (!response.ok) {
          console.error("Failed to load questions");
          return;
        }
        const latestQuestions = await response.json();
        allQuestions = latestQuestions; // Update the global variable
        renderQuestions(latestQuestions); // Render all questions
      } catch (error) {
        console.error("Error loading latest questions:", error);
      }
    }

    // Function to render questions dynamically
    function renderQuestions(questions) {
      const questionsList = document.getElementById("questions-list");
      questionsList.innerHTML = ""; // Clear previous questions

      if (questions.length === 0) {
        questionsList.innerHTML = `<p style="text-align: center; padding: 20px;">No results found</p>`;
        return;
      }

      questions.forEach((q) => {
        const questionElem = document.createElement("div");
        questionElem.classList.add("question");
        questionElem.innerHTML = `
          <div class="question-header">
            <h4>${q.title}</h4>
            <p class="question-meta">
              <i class="fas fa-user"></i> Posted by: ${q.username} | Time: ${new Date(q.time).toLocaleString()}
            </p>
            <div class="three-dot-menu">
              <span class="dots">&#8226;&#8226;&#8226;</span>
              <div class="menu-options">
                <button class="delete-btn">Delete</button>
                <button class="report-btn">Report</button>
              </div>
            </div>
          </div>
          <div class="question-body">
            <p>${q.question}</p>
          </div>
          <button class="reply-btn"><i class="fas fa-reply"></i> Reply</button>
          <div class="replies">
            <div class="reply-form" style="display: none;">
              <textarea class="reply-body" placeholder="Write your reply here..."></textarea>
              <button class="submit-reply"><i class="fas fa-paper-plane"></i> Post Reply</button>
              <button class="cancel-reply"><i class="fas fa-times"></i> Cancel</button>
            </div>
          </div>
          <div class="replies-list" style="display: none;"></div>
          <button class="toggle-replies-btn" style="display: none;">Show Replies</button>
        `;

        // QUESTION MENU EVENTS
        const threeDotMenu = questionElem.querySelector(".three-dot-menu");
        const menuOptions = threeDotMenu.querySelector(".menu-options");
        const deleteBtn = questionElem.querySelector(".delete-btn");
        const reportBtn = questionElem.querySelector(".report-btn");

        threeDotMenu.addEventListener("click", function (e) {
          e.stopPropagation();
          menuOptions.classList.toggle("show");
        });
        deleteBtn.addEventListener("click", function (e) {
          const qElement = e.target.closest(".question");
          if (qElement) qElement.remove();
        });
        reportBtn.addEventListener("click", function () {
          document.getElementById("report-modal").style.display = "flex";
        });

        // REPLY FUNCTIONALITY
        const replyBtn = questionElem.querySelector(".reply-btn");
        const replyForm = questionElem.querySelector(".reply-form");
        const submitReplyBtn = questionElem.querySelector(".submit-reply");
        const cancelReplyBtn = questionElem.querySelector(".cancel-reply");
        const repliesList = questionElem.querySelector(".replies-list");
        const toggleRepliesBtn = questionElem.querySelector(".toggle-replies-btn");

        replyBtn.addEventListener("click", function () {
          replyForm.style.display = "block";
          replyBtn.style.display = "none";
        });
        cancelReplyBtn.addEventListener("click", function () {
          replyForm.style.display = "none";
          replyBtn.style.display = "inline-block";
        });
        toggleRepliesBtn.addEventListener("click", function () {
          const visible = repliesList.style.display !== "none";
          repliesList.style.display = visible ? "none" : "block";
          toggleRepliesBtn.innerText = visible ? "Show Replies" : "Hide Replies";
        });

        // Render existing replies, if any
        if (q.replies && Array.isArray(q.replies) && q.replies.length > 0) {
          q.replies.forEach((reply) => {
  reply.comments = reply.comments || [];

  const replyDiv = document.createElement("div");
  replyDiv.classList.add("reply");
  replyDiv.innerHTML = `
    <div class="reply-content">
      <div class="reply-text"><p><strong>${reply.user}</strong>: ${reply.reply}</p></div>
      <div class="reply-three-dot-menu">
        <span class="dots">&#8226;&#8226;&#8226;</span>
        <div class="menu-options">
          <button class="delete-reply-btn">Delete</button>
          <button class="report-reply-btn">Report</button>
          <button class="view-comments-btn">💬 View Comments</button>
        </div>
      </div>
    </div>
  `;

  repliesList.appendChild(replyDiv);


// Add "Reply to this reply" button
const replyToReplyBtn = document.createElement("button");
replyToReplyBtn.textContent = "Reply";
replyToReplyBtn.classList.add("small-reply-btn");
replyDiv.appendChild(replyToReplyBtn);


  const replyDots = replyDiv.querySelector(".reply-three-dot-menu .dots");
  const replyMenuOptions = replyDiv.querySelector(".reply-three-dot-menu .menu-options");

  replyDots.addEventListener("click", function (e) {
    e.stopPropagation();
    replyMenuOptions.classList.toggle("show");
  });

  replyDiv.querySelector(".delete-reply-btn").addEventListener("click", function () {
    replyDiv.remove();
    updateToggleReplies(repliesList, toggleRepliesBtn);
  });

  replyDiv.querySelector(".report-reply-btn").addEventListener("click", function () {
    document.getElementById("report-modal").style.display = "flex";
  });


  

});



          

          
           
          // If there are any replies, show the toggle button.
          toggleRepliesBtn.style.display = "inline-block";
        } else {
          toggleRepliesBtn.style.display = "none";
        }

        // Post a new reply
        submitReplyBtn.addEventListener("click", async function (event) {
          event.preventDefault();
          const replyText = questionElem.querySelector(".reply-body").value;
          if (replyText) {
            try {
              const replyResponse = await fetch("/Q&A/reply", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ reply: replyText, ID: q.ID }),
                credentials: "include"
              });
              if (!replyResponse.ok) {
                alert("Error posting reply.");
                return;
              }
              const newReplyDiv = document.createElement("div");
              newReplyDiv.classList.add("reply");
              newReplyDiv.innerHTML = `
                <div class="reply-content">
                  <div class="reply-text"><p><strong>You</strong>: ${replyText}</p></div>
                  <div class="reply-three-dot-menu">
                    <span class="dots">&#8226;&#8226;&#8226;</span>
                    <div class="menu-options">
                      <button class="delete-reply-btn">Delete</button>
                      <button class="report-reply-btn">Report</button>
                    </div>
                  </div>
                </div>
              `;
              repliesList.appendChild(newReplyDiv);
              const newReplyDots = newReplyDiv.querySelector(".reply-three-dot-menu .dots");
              const newReplyMenuOptions = newReplyDiv.querySelector(".reply-three-dot-menu .menu-options");
              newReplyDots.addEventListener("click", function (e) {
                e.stopPropagation();
                newReplyMenuOptions.classList.toggle("show");
              });
              newReplyDiv.querySelector(".delete-reply-btn").addEventListener("click", function () {
                newReplyDiv.remove();
                updateToggleReplies(repliesList, toggleRepliesBtn);
              });
              newReplyDiv.querySelector(".report-reply-btn").addEventListener("click", function () {
                document.getElementById("report-modal").style.display = "flex";
              });
              questionElem.querySelector(".reply-body").value = "";
              repliesList.style.display = "block";
              toggleRepliesBtn.innerText = "Hide Replies";
              updateToggleReplies(repliesList, toggleRepliesBtn);
            } catch (error) {
              console.error("Error posting reply:", error);
              alert("Error posting reply.");
            }
          }
        });

        questionsList.appendChild(questionElem);
      });
    }

    // Live search functionality
    const searchInput = document.querySelector(".search-input");
    searchInput.addEventListener("input", function () {
      const searchQuery = this.value.toLowerCase();
      renderQuestions(searchQuery === "" ? allQuestions : allQuestions.filter(q => q.title.toLowerCase().includes(searchQuery)));
    });
    searchInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        const searchQuery = this.value.toLowerCase();
        renderQuestions(searchQuery === "" ? allQuestions : allQuestions.filter(q => q.title.toLowerCase().includes(searchQuery)));
      }
    });

    // Submit new question
    document.getElementById("question-form").addEventListener("submit", async function (event) {
      event.preventDefault();
      const title = document.getElementById("question-title").value;
      const body = document.getElementById("question-body").value;
      if (title && body) {
        try {
          const response = await fetch("/Q&A", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: title, question: body }),
            credentials: "include"
          });
          if (!response.ok) {
            alert("Error posting question.");
            return;
          }
          document.getElementById("question-title").value = "";
          document.getElementById("question-body").value = "";
          document.getElementById("review-modal").style.display = "none";
          loadLatestQuestions();
        } catch (error) {
          console.error("Error posting question:", error);
          alert("Error posting question.");
        }
      }
    });

    function closeReportModal() {
      document.getElementById("report-modal").style.display = "none";
      document.getElementById("report-reason").value = "";
    }
    document.getElementById("report-form").addEventListener("submit", function (event) {
      event.preventDefault();
      const reason = document.getElementById("report-reason").value;
      alert("Report submitted: " + reason);
      closeReportModal();
    });
    document.addEventListener("click", function (e) {
      document.querySelectorAll(".menu-options").forEach(menu => menu.classList.remove("show"));
    });
    document.addEventListener("DOMContentLoaded", loadLatestQuestions);


    let activeReply = null; // store the current reply being commented on

// Modal logic
const commentModal = document.getElementById("comment-modal");
const closeCommentModalBtn = document.getElementById("close-comment-modal");
const commentThread = document.getElementById("comment-thread");
const commentInput = document.getElementById("comment-input");
const submitCommentBtn = document.getElementById("submit-comment-btn");

closeCommentModalBtn.addEventListener("click", () => {
  commentModal.style.display = "none";
  commentThread.innerHTML = "";
  commentInput.value = "";
  activeReply = null;
});

submitCommentBtn.addEventListener("click", () => {
  const commentText = commentInput.value.trim();
  if (commentText && activeReply) {
    activeReply.comments = activeReply.comments || [];
    activeReply.comments.push({
      user: "You",
      text: commentText
    });

    // Render
    const commentDiv = document.createElement("div");
    commentDiv.classList.add("comment");
    commentDiv.innerHTML = `<strong>You:</strong> ${commentText}`;
    commentThread.appendChild(commentDiv);

    commentInput.value = "";
  }
});


  </script>
</body>
</html>