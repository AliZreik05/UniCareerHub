<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/ReviewsStyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Reviews</title>
</head>
<body>
    <div class="navbar">
        <div class="logo"><a href="/">UniCareerHub</a></div>
        <div class="nav-title">Reviews</div>
    </div>

    <div class="intro-text">
        Have a review? Share your experience!<br>
        Connect with fellow students and professionals.
    </div>

    <section id="qa-section">
        <div class="container">
            <button id="open-modal" class="submit-btn"> <i class="fas fa-plus"></i> Submit a Review</button>
            <div class="questions-list" id="reviews-list"></div>
        </div>
    </section>
    
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3><i class="fas fa-pen-nib"></i> Submit a Review</h3>
            <form id="review-form" class="ask-question">
                <div class="form-group">
                    <label for="review-title">Title of Your Review</label>
                    <input type="text" id="review-title" name="title" placeholder="Enter a descriptive review title" required>
                </div>
                <div class="form-group">
                    <label for="review-body">Details</label>
                    <textarea id="review-body" name="body" placeholder="Provide details about your review" required></textarea>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-paper-plane"></i> Post Review</button>
            </form>
        </div>
    </div>
    
    <script>
        // Open the modal when the submit button is clicked
        document.getElementById('open-modal').addEventListener('click', function() {
            document.getElementById('review-modal').style.display = 'block';
        });
        
        // Close the modal when the close button is clicked
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('review-modal').style.display = 'none';
        });
        
        // Close the modal if user clicks outside it
        window.onclick = function(event) {
            if (event.target === document.getElementById('review-modal')) {
                document.getElementById('review-modal').style.display = 'none';
            }
        };

        async function loadLatestReviews() {
            try {
                const response = await fetch('/reviews/latest');  // Make sure this endpoint returns the latest 10 reviews in JSON format
                if (!response.ok) {
                    console.error('Failed to load reviews');
                    return;
                }
                const latestReviews = await response.json();
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = "";  // Clear any existing reviews
                latestReviews.forEach(review => {
                    const reviewElem = document.createElement('div');
                    reviewElem.classList.add('review');
                    reviewElem.innerHTML = `
                    <div class="review-header">
                        <h4>${review.title}</h4>
                        <p class="review-meta"><i class="fas fa-user"></i> Posted by: ${review.username} | Time: ${review.time}</p>
                    </div>
                    <div class="review-body">
                        <p>${review.review}</p>
                    </div>
                    `;
                    reviewsList.appendChild(reviewElem);
                });
            } catch (error) {
                console.error('Error loading latest reviews:', error);
            }
        }

        // Handle the review form submission
        document.getElementById('review-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const title = document.getElementById('review-title').value;
            const body = document.getElementById('review-body').value;
            if (title && body) {
                try {
                    const response = await fetch('/reviews', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // Pass the keys matching your backend: user, title, and review
                        body: JSON.stringify({ user: "DefaultUser", title: title, review: body })
                    });
                    if (!response.ok) {
                        alert('Error posting review.');
                        return;
                    }
                    const result = await response.json();
                    // Create a new review element with consistent naming
                    const newReview = document.createElement('div');
                    newReview.classList.add('review');
                    newReview.innerHTML = `
                    <div class="review-header">
                        <h4>${title}</h4>
                        <p class="review-meta"><i class="fas fa-user"></i><strong> Posted by:</strong> You | <strong>Time:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                    <div class="review-body">
                        <p>${body}</p>
                    </div>
                    <button class="reply-btn"><i class="fas fa-reply"></i> Reply</button>
                    <div class="replies" style="display:none;">
                        <textarea class="reply-body" placeholder="Write your reply here..."></textarea>
                        <button class="submit-reply"><i class="fas fa-paper-plane"></i> Post Reply</button>
                    </div>
                    <div class="replies-list"></div>
                    `;
                    const replyBtn = newReview.querySelector('.reply-btn');
                    const repliesDiv = newReview.querySelector('.replies');
                    const submitReplyBtn = newReview.querySelector('.submit-reply');
                    const repliesList = newReview.querySelector('.replies-list');
                    replyBtn.addEventListener('click', function() {
                        repliesDiv.style.display = repliesDiv.style.display === 'none' ? 'block' : 'none';
                    });
                    submitReplyBtn.addEventListener('click', function() {
                        const replyBody = newReview.querySelector('.reply-body').value;
                        if (replyBody) {
                            const newReply = document.createElement('div');
                            newReply.classList.add('reply');
                            newReply.innerHTML = `<p><strong>You</strong>: ${replyBody}</p>`;
                            repliesList.appendChild(newReply);
                            newReview.querySelector('.reply-body').value = '';
                        }
                    });
                    document.getElementById('reviews-list').prepend(newReview);
                    // Clear form fields and hide modal
                    document.getElementById('review-title').value = '';
                    document.getElementById('review-body').value = '';
                    document.getElementById('review-modal').style.display = 'none';
                } catch (error) {
                    console.error('Error posting review:', error);
                    alert('Error posting review.');
                }
            }
        });
        
        document.addEventListener('DOMContentLoaded', loadLatestReviews);
    </script>
</body>
</html>